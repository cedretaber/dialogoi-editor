# Dialogoi Editor

[![CI](https://github.com/cedretaber/dialogoi-editor/actions/workflows/ci.yml/badge.svg)](https://github.com/cedretaber/dialogoi-editor/actions/workflows/ci.yml)

VSCode Extension として提供する小説執筆支援ツール

## 概要

Dialogoi Editor は、小説作品の執筆を支援するVSCode Extensionです。本文の管理だけでなく、設定・キャラクター・用語集・伏線などの情報を体系的に管理し、作品の一貫性を保ちながら執筆を進めることができます。

将来的には [Dialogoi MCP サーバ](https://github.com/cedretaber/dialogoi) との連携も予定しています。

## 主な機能

### ✅ 実装済み機能

#### 🚀 Phase 1: 基本ファイル管理 (完了)
- 📚 **階層的なファイル管理** - 本文と設定ファイルを構造化して管理
- 🗂️ **TreeView表示** - 小説構造を視覚的に表示
- 📄 **ファイル操作** - 作成・削除・名前変更・並び替え
- 📋 **meta.yaml管理** - メタデータの読み書き機能
- 🎨 **アイコン表示** - ファイル種別に応じたアイコン
- 📖 **READMEファイル表示** - ディレクトリクリックでREADME開く
- 🔧 **拡張子自動付与** - .txt/.md の自動判別

#### 📝 Phase 2a: メタデータ管理 (完了)
- 🏷️ **タグシステム** - ファイルやディレクトリにタグを付けて分類・表示
- 🔗 **参照関係の管理** - 設定がどの話で使われているかを双方向追跡
- 💡 **ツールチップ表示** - マウスオーバーでタグと参照関係を表示
- ⚠️ **参照整合性チェック** - 存在しないファイルへの参照を検出・表示

#### 📝 Phase 2b: コメント・TODO機能 (完了)
- 📝 **コメント・TODO統合管理** - 執筆メモ・TODOの一元管理
- 🔍 **ファイルハッシュ変更検知** - SHA-256ハッシュによるファイル変更追跡
- 📍 **GitHub風行番号形式** - #L42, #L4-L7による位置指定
- 📊 **ステータス管理** - open/resolved による進捗管理
- ✏️ **マークダウン・TODO対応** - リアルタイムプレビューとチェックボックス
- 🗑️ **インライン編集機能** - クリック→編集→自動保存
- 📋 **専用コメントパネル** - サイドバー独立配置によるUI改善

#### 📝 Phase 2c: プロジェクト管理機能 (完了)
- 📦 **dialogoi.yaml** - プロジェクトメタデータの管理（タイトル、著者、バージョン、作成日、タグ）
- ⚙️ **プロジェクト設定** - READMEファイル名、除外パターンの設定
- 🚀 **プロジェクト新規作成** - 既存ディレクトリから小説プロジェクトを自動生成
- 🔄 **再帰的スキャン** - サブディレクトリを含めた全ファイルの自動検出
- 📄 **自動meta.yaml生成** - ファイル種別の自動判定（.txt→content、.md→setting）
- 🔒 **既存データ保護** - 既存のmeta.yamlファイルを尊重
- 🚫 **除外パターン** - 不要なファイル（隠しファイル、システムファイル等）の除外

#### 🏗️ アーキテクチャ改善 (完了)
- 🎯 **依存関係注入（DI）** - VSCode依存の局所化とテスト可能性の向上
- 🧪 **MockFileOperationService** - ファイルシステムに依存しない高速テスト
- 🔧 **抽象化レイヤー** - FileOperationServiceとUriインターフェースによる抽象化
- 📦 **ServiceContainer** - 依存関係の一元管理
- 🧹 **後方互換性削除** - 不要な分岐コードの削除による保守性向上

#### 🎨 Phase 3.1: WebView統合UI (完了)
- 📱 **Activity Bar統合** - 「Dialogoi詳細」ViewContainerを追加
- 🌲 **TreeView統合** - ファイル選択機能をDialogoiパネル内に統合
- 🌐 **WebView詳細画面** - リッチなHTML表示によるメタデータ表示
- 📁 **VSCodeエクスプローラー風UI** - 折りたたみ可能セクション形式
- ⚡ **リアルタイム連携** - ファイル選択時の即座な詳細表示更新
- 🎯 **統合ワークフロー** - 1つのパネルでファイル選択から詳細表示まで完結

#### 🎨 Phase 3.2a: タグ編集機能改善 (完了)
- ✏️ **インラインタグ編集** - プロンプトダイアログ不要の直感的な編集UI
- ⌨️ **Enterキー対応** - キーボードショートカットによる高速タグ追加
- ❌ **個別タグ削除** - 各タグに削除ボタン（×）を配置
- 🔄 **リアルタイム同期** - TreeViewとWebViewの即座な同期更新
- ✅ **重複検証** - タグの重複を自動検証・防止

#### 🎨 Phase 3.2c: 検索・フィルタリング機能 (完了)
- 🏷️ **タグフィルタリング** - 指定タグを持つファイル・ディレクトリのみ表示
- 📁 **再帰的フィルタリング** - 深い階層構造でも正確にフィルタリング
- 🔍 **フィルターボタン** - TreeViewタイトルバーにフィルター/クリアボタン配置
- ⚙️ **VSCode設定統合** - files.excludeでDialogoiメタファイルを検索から自動除外
- 📚 **カスタムアイコン** - Activity Barに本型SVGアイコンを表示
- ⚡ **リアルタイム更新** - フィルター条件に応じた即座のTreeView更新

#### 🎨 Phase 3.3a: 新規プロジェクト作成ボタン (完了)
- 🆕 **新しい小説を開始ボタン** - プロジェクトが存在しない場合にウェルカム画面を表示
- 📝 **簡単入力フォーム** - タイトル・著者・タグの入力でプロジェクト作成
- ⚙️ **プロジェクト設定編集** - dialogoi.yamlファイルの直接編集機能
- 🎯 **ワンクリック開始** - 既存プロジェクト作成機能のUI化
- 🖼️ **Activity Bar表示改善** - 空ディレクトリでもDialogoiアイコンを表示
- 📁 **ファイル作成機能強化** - キャラクター・伏線・用語集の専用メタデータ自動設定
- 📄 **拡張子の適切な割り当て** - 本文ファイル(.txt)と設定ファイル(.md)の明確な区別
- 🔧 **コード品質向上** - パス命名規則の厳格化で絶対パス/相対パスの取り違えを防止

#### 🎨 Phase 3.3b: 拡張ドラッグ&ドロップ機能 (完了)
- 🖱️ **ドラッグ&ドロップ並び替え** - ファイル・ディレクトリの直感的な順序変更
- 📁 **異なるディレクトリへの移動** - ファイルを別フォルダにドラッグして移動
- 🗂️ **ディレクトリの階層移動** - フォルダ構造の柔軟な再構成（循環参照検出付き）
- 🗑️ **ディレクトリ削除機能** - 確認ダイアログ付きの安全な削除
- ❓ **操作種別確認ダイアログ** - 並び替えか移動かを明確に判定
- 🔄 **メタデータ整合性保持** - 移動・削除時の自動的なメタデータ更新
- ↩️ **ロールバック機能** - 操作失敗時の自動的な状態復元

#### 🎨 Phase 3.4: ハイパーリンク統合機能 (完了)
- 🔗 **ハイパーリンク自動抽出** - マークダウンファイル内のリンクを自動検出・表示
- 🔄 **リアルタイム更新** - ファイル保存時の参照関係自動更新
- 🎯 **統合参照管理** - 手動参照とハイパーリンク参照の統一管理
- 🖱️ **ドラッグ&ドロップ参照追加** - TreeViewからエディタへのドラッグで参照追加
- 📝 **設定ファイルへのマークダウンリンク生成** - 設定ファイルドロップ時の自動リンク挿入
- 🔗 **視覚的区別表示** - ハイパーリンク由来の参照に🔗アイコン表示

#### 🎨 Phase 3.5: アクティブエディタ連携機能 (完了)
- 📖 **タブ切り替え連携** - VSCodeタブでファイルを開いた時の自動FileDetailsView更新
- 🚀 **起動時ファイル認識** - VSCode起動時のアクティブファイル詳細表示
- 🔍 **ファイルパス検索機能** - 絶対パスからDialogoiTreeItemの高速検索
- 🎯 **完全な操作統合** - TreeView選択・タブ切り替え・起動時ファイルすべてに対応

### 🔮 今後の実装予定

#### 🎨 Phase 3.6: 残りのUI/UX改善
- ✏️ **ファイル作成・名前変更の改善** - インライン編集による高速操作
- 📁 **管理対象外ファイルの可視化** - .dialogoi-meta.yamlに未記載のファイルを薄色表示
- ⚙️ **プロジェクト設定の視覚的編集** - YAML直接編集の代替GUI
- 🔮 **伏線設定の複数張り位置対応** - 複数箇所での伏線設定
- 📋 **コンテキストメニューの充実** - より多くの操作をメニューから実行
- ⌨️ **キーボードショートカット** - 効率的な操作のためのショートカット
- 🌏 **多言語対応** - 日本語を優先とした国際化
- 🔧 **FileDetailsViewProviderリファクタリング** - ロジックをservices/に移動・テスト追加

#### 🔍 Phase 4: 高度な分析機能
- 📊 **伏線可視化** - タイムライン表示による伏線管理
- 🕸️ **キャラクター相関図** - 登場人物の関係性を図表化
- 📈 **執筆統計** - 文字数、更新頻度等の分析
- 🔗 **参照関係グラフ** - 設定間の関係を視覚化

## インストール方法

（準備中）

## 使い方

### クイックスタート

1. **開発環境でのテスト**
   ```bash
   # リポジトリをクローン
   git clone https://github.com/cedretaber/dialogoi-editor.git
   cd dialogoi-editor
   
   # 依存関係のインストール
   npm install
   
   # Extension をコンパイル
   npm run compile
   
   # VSCode でデバッグ実行（F5 キーでも可能）
   code .
   ```

2. **サンプルプロジェクトで動作確認**
   - VSCode で F5 キーを押してExtension開発環境を起動
   - 新しいウィンドウで `examples/sample-novel` フォルダを開く
   - 左サイドバーの「エクスプローラー」に「Dialogoi」セクションが表示されます
   - TreeView で小説の構造を確認できます

3. **新規プロジェクトの作成**
   - 既存のディレクトリを小説プロジェクトに変換できます
   - Dialogoi TreeView の「新規プロジェクト作成」機能を使用
   - `dialogoi.yaml` とファイル構造に応じた `meta.yaml` が自動生成されます

### サンプルプロジェクトの内容

`examples/sample-novel` には以下の構造のサンプル小説が含まれています：

- 📖 **本文** - 4つの章（プロローグ〜第3章）
- 👥 **キャラクター** - 主人公、ヒロイン、親友、教師陣
- 🌍 **世界設定** - 魔法学院の世界観
- 📚 **用語集** - 作品内用語の定義
- 🔮 **伏線** - 3つの主要な伏線設定

このサンプルは実際の小説執筆での Extension の使い方を示しています。

### 基本的な使い方

#### ファイル管理
1. **ファイル作成**: TreeView の「+」ボタンまたは右クリックメニューから
2. **ファイル削除**: 右クリックメニューから削除
3. **ディレクトリ削除**: ディレクトリを右クリック →「ディレクトリを削除」（確認ダイアログ付き）
4. **名前変更**: 右クリックメニューから名前変更
5. **ドラッグ&ドロップ**: ファイル・ディレクトリをドラッグして並び替え・移動
6. **ディレクトリ操作**: ディレクトリをクリックでREADME.mdが開く

#### ドラッグ&ドロップ機能
1. **同一階層での並び替え**: ファイル・ディレクトリを同じフォルダ内で別のアイテムにドロップ
2. **異なるディレクトリへの移動**: ファイルを別のフォルダにドラッグして移動
3. **ディレクトリの階層移動**: フォルダを別の階層にドラッグして移動
4. **操作種別の確認**: ディレクトリにドロップ時に並び替え/移動を選択できるダイアログ表示
5. **自動メタデータ更新**: 移動・並び替え時に.dialogoi-meta.yamlが自動更新

#### タグ管理
1. **タグ追加**: ファイルを右クリック →「タグを追加」
2. **タグ削除**: ファイルを右クリック →「タグを削除」
3. **タグ編集**: ファイルを右クリック →「タグを編集」
4. **タグ表示**: TreeView でファイル名の右に #タグ 形式で表示
5. **インラインタグ編集**: WebView詳細画面でタグの直接追加・削除

#### 参照関係管理
1. **参照追加**: ファイルを右クリック →「参照を追加」
2. **参照削除**: ファイルを右クリック →「参照を削除」
3. **参照編集**: ファイルを右クリック →「参照を編集」
4. **参照確認**: ファイルにマウスオーバーでツールチップに参照関係表示

#### レビュー機能
1. **レビュー追加**: ファイルを右クリック →「レビューを追加」
2. **レビュー表示**: ファイルを右クリック →「レビューを表示」
3. **レビューステータス更新**: ファイルを右クリック →「レビューステータスを更新」
4. **レビュー削除**: ファイルを右クリック →「レビューを削除」
5. **レビューファイル**: 対象ファイルと同じディレクトリに `_reviews.yaml` ファイルが作成される

#### プロジェクト管理
1. **新しい小説を開始**: プロジェクトが存在しない場合、ウェルカム画面から「新しい小説を開始」をクリック
2. **簡単入力**: タイトル・著者・タグ（省略可）を入力してプロジェクト作成
3. **プロジェクト設定編集**: TreeViewタイトルバーの「⚙️」ボタンからdialogoi.yamlを直接編集
4. **自動ファイル検出**: 既存ディレクトリから適切なファイルを自動検出
5. **除外パターン**: 不要なファイル（隠しファイル、システムファイル等）を自動除外

#### 検索・フィルタリング
1. **タグフィルター**: TreeViewタイトルバーの「🔍」ボタンから
2. **フィルター入力**: タグ名を入力してEnterキーで実行
3. **フィルタークリア**: TreeViewタイトルバーの「✖」ボタンから
4. **対象範囲**: ファイル・ディレクトリを再帰的に検索
5. **VSCode設定統合**: Dialogoiメタファイルは自動的に検索から除外

#### メタデータ
- **自動更新**: meta.yamlファイルが自動更新される
- **参照整合性**: 存在しないファイルへの参照は警告表示される
- **変更検知**: SHA-256ハッシュによるファイル変更追跡

## ドキュメント

詳細なドキュメントは以下を参照してください：

- [仕様書](docs/SPECIFICATION.md) - ファイル形式やメタデータの詳細仕様
- [アーキテクチャ設計書](docs/ARCHITECTURE.md) - 技術的な設計と実装方針
- [ロードマップ](docs/ROADMAP.md) - 今後の開発計画と将来構想

## 開発に参加する

このプロジェクトはオープンソースです。バグ報告、機能提案、プルリクエストを歓迎します。

### 開発環境のセットアップ

```bash
# リポジトリのクローン
git clone https://github.com/cedretaber/dialogoi-editor.git
cd dialogoi-editor

# 依存関係のインストール
npm install

# TypeScriptコンパイル
npm run compile

# 開発モードで監視（ファイル変更時に自動コンパイル）
npm run watch
```

### デバッグ実行

```bash
# VSCode内でF5キーを押すか、以下で新しいウィンドウでExtensionをテスト
code --extensionDevelopmentPath=.
```

### テスト

```bash
# 標準テスト（CI対応）
npm test

# VSCode環境でのテスト（開発用）
npm run test:vscode
```

### パッケージング

```bash
# Extensionファイル（.vsix）の作成
npm run package
```

## ライセンス

MIT
