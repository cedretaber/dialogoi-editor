# ファイル新規作成・名前変更のインライン編集機能改善計画

## 📋 概要

VSCode TreeView APIの制限により真のインライン編集は実現できないため、現在のダイアログベース編集のユーザビリティを大幅に向上させる。

## 🎯 目標

### 主要目標
- **F2キー対応**: エクスプローラーと同様のキーボードショートカット
- **入力体験向上**: より直感的な編集ダイアログ
- **操作の簡素化**: 不要なステップの削減
- **エラーハンドリング強化**: バリデーション・フィードバック改善

### 制約事項
- VSCode TreeView APIに真のインライン編集機能は存在しない
- 現在のダイアログベース編集を前提とした改善のみ実装可能

## 🛠️ 実装フェーズ

### Phase 1: キーボードショートカット対応
**目標**: F2キーで名前変更、Ctrl+N（またはCmd+N）でファイル作成

#### 1.1 package.json keybindings追加
```json
{
  "contributes": {
    "keybindings": [
      {
        "command": "dialogoi.renameFile",
        "key": "F2",
        "when": "view == dialogoi-explorer && viewItem"
      },
      {
        "command": "dialogoi.createFile", 
        "key": "ctrl+n",
        "mac": "cmd+n",
        "when": "view == dialogoi-explorer"
      }
    ]
  }
}
```

#### 1.2 コマンド改善
- 現在選択中のアイテムを自動検出する機能
- キーバインド経由での呼び出しに対応

### Phase 2: 入力体験の向上
**目標**: より直感的で分かりやすい入力ダイアログ

#### 2.1 名前変更の改善
- **リアルタイムバリデーション**: 入力中の名前重複チェック
- **拡張子の自動処理**: ファイル種別に応じた拡張子の自動付与・表示
- **プレビュー表示**: 変更後の完全パスの表示

#### 2.2 ファイル作成の改善
- **ワンステップ化**: 可能な場合は種別選択と名前入力を統合
- **コンテキスト推定**: 選択位置から適切なファイル種別を推測
- **テンプレート対応**: ファイル種別ごとのテンプレート挿入

### Phase 3: エラーハンドリング・バリデーション強化
**目標**: より親切なエラーメッセージとガイダンス

#### 3.1 バリデーション機能
- **リアルタイム名前チェック**: 既存ファイルとの重複検出
- **不正文字チェック**: OS・ファイルシステム制限の検証
- **長さ制限チェック**: パス長制限の事前確認

#### 3.2 ユーザーガイダンス
- **入力ヒント表示**: プレースホルダーとヘルプテキスト
- **操作ガイド**: キーボードショートカットの表示
- **エラー修正提案**: 不正入力時の修正候補提示

### Phase 4: ファイル詳細パネル内インライン編集
**目標**: ファイル詳細パネル内での直感的なファイル名編集

#### 4.1 直接編集インターフェース
- **クリックで編集**: ファイル名をクリックすると編集モードに切り替わり
- **フォーカスアウト保存**: フォーカスを外すと自動で保存
- **キーボードショートカット**: Enterキーで保存、Escapeキーでキャンセル
- **リアルタイムバリデーション**: 入力中の即座なフィードバック

#### 4.2 高度なUX機能
- **視覚的フィードバック**: 編集状態の明確な表示
- **エラー表示**: インライン形式の親切なエラーメッセージ
- **保存状態表示**: 保存中/完了の視覚的な合図
- **アクセシビリティ対応**: スクリーンリーダー等への適切な対応

### Phase 5: 高度な機能（将来的）
**目標**: よりパワフルな編集機能

#### 5.1 一括操作機能
- **複数選択対応**: 複数ファイルの一括名前変更（将来的）
- **パターン置換**: 正規表現による名前変更（将来的）

#### 5.2 履歴・アンドゥ機能
- **操作履歴**: 最近の名前変更履歴表示
- **アンドゥ対応**: VSCode標準アンドゥとの連携

## 📝 実装詳細

### キーバインド実装
```typescript
// src/commands/fileCommands.ts での改善例
export async function handleRenameFileFromKeyboard(context: vscode.ExtensionContext): Promise<void> {
  // 現在選択中のTreeViewアイテムを取得
  const selectedItem = await getSelectedTreeItem();
  if (!selectedItem) {
    vscode.window.showWarningMessage('名前を変更するファイルを選択してください');
    return;
  }
  
  // 既存のrenameFile関数を呼び出し
  await renameFile(selectedItem);
}
```

### バリデーション強化例
```typescript
async function validateFileName(name: string, currentPath: string): Promise<string | undefined> {
  // 1. 空文字チェック
  if (!name.trim()) {
    return 'ファイル名を入力してください';
  }
  
  // 2. 不正文字チェック  
  const invalidChars = /[<>:"/\\|?*]/g;
  if (invalidChars.test(name)) {
    return 'ファイル名に使用できない文字が含まれています: < > : " / \\ | ? *';
  }
  
  // 3. 重複チェック
  const targetPath = path.join(path.dirname(currentPath), name);
  if (await fileExists(targetPath)) {
    return 'この名前のファイルは既に存在します';
  }
  
  return undefined; // バリデーション成功
}
```

## 🎯 成功基準

### Phase 1 完了基準
- [x] F2キーで名前変更が動作する
- [x] Ctrl+N/Cmd+Nでファイル作成が動作する
- [x] キーバインドのwhen条件が正しく動作する

### Phase 2 完了基準
- [x] リアルタイムバリデーションが動作する
- [x] 拡張子の自動処理が動作する
- [x] プレビュー表示が実装される

### Phase 3 完了基準
- [ ] 包括的なバリデーション機能
- [ ] 親切なエラーメッセージ
- [ ] ユーザーガイダンス機能

### Phase 4 完了基準
- [ ] ファイル詳細パネル内のインライン編集が動作する
- [ ] クリック→編集→フォーカスアウト→保存の流れが完璧に動作する
- [ ] リアルタイムバリデーションがインライン形式で表示される
- [ ] キーボードショートカット（Enter/Escape）が動作する
- [ ] エラーハンドリングが適切に動作する

## 📊 期待される効果

### ユーザビリティ向上
- **操作時間短縮**: キーボードショートカットによる高速操作
- **直感性向上**: エクスプローラーと同様の操作感
- **エラー削減**: リアルタイムバリデーションによるミス防止

### 開発効率向上
- **ファイル管理効率化**: より高速なファイル作成・名前変更
- **学習コスト削減**: VSCode標準操作との統一感

## 🚧 技術的課題と対応

### VSCode API制限
- **問題**: TreeItemの真のインライン編集は不可能
- **対応**: ダイアログベース編集の最適化に注力

### パフォーマンス考慮
- **問題**: リアルタイムバリデーションの処理負荷
- **対応**: 適切なデバウンス処理の実装

### 互換性維持
- **問題**: 既存の操作フローとの整合性
- **対応**: 既存機能は維持し、改善として追加実装

---

**注**: この計画は現実的な改善を重視し、VSCode Extension APIの制限内で最大限のユーザビリティ向上を目指します。