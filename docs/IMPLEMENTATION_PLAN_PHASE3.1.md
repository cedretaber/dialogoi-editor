# Phase 3.1 実装計画書

## 実装概要

WebView詳細画面の段階的実装により、現在のツールチップベースの情報表示を高機能なリッチUI画面に置き換える。

## 実装順序と詳細

### Phase 3.1a: 基本WebView実装 🎯 **最優先**

#### 1. package.json更新
**ファイル**: `/package.json`  
**変更内容**:
```json
{
  "contributes": {
    "views": {
      "explorer": [
        {
          "type": "webview",
          "id": "dialogoi-file-details", 
          "name": "ファイル詳細",
          "when": "dialogoi:hasNovelProject",
          "icon": "$(info)"
        }
      ]
    }
  }
}
```

#### 2. FileDetailsViewProvider作成
**ファイル**: `/src/views/FileDetailsViewProvider.ts`  
**実装内容**:
- `vscode.WebviewViewProvider` インターフェイス実装
- 基本的なHTML構造の生成
- CSP設定とセキュリティ対応
- メッセージング基盤の実装

**依存関係**:
- DialogoiTreeItem型の活用
- 既存のServiceContainerとの連携

#### 3. extension.ts統合
**ファイル**: `/src/extension.ts`  
**変更内容**:
- FileDetailsViewProviderの登録
- TreeView選択変更イベントとの連携
- サブスクリプション管理

#### 4. 基本的なHTML/CSS
**機能**:
- VSCode標準テーマとの整合性
- レスポンシブデザイン
- アクセシビリティ対応

### Phase 3.1b: アコーディオンUI実装

#### 1. アコーディオンパネルの構造
**HTML構造**:
```html
<div class="accordion">
  <div class="accordion-header">タグ情報</div>
  <div class="accordion-content">
    <!-- タグ一覧 -->
  </div>
</div>
```

#### 2. JavaScript開閉制御
**機能**:
- クリックによる開閉切り替え
- アニメーション効果
- 状態保持（localStorage活用）

#### 3. CSS Styling
**特徴**:
- VSCodeテーマ変数の活用
- 統一されたスペーシング
- ホバー効果とフォーカス状態

### Phase 3.1c: 表示内容の充実

#### 1. タグ表示の実装
**表示内容**:
- 現在のタグを `#タグ名` 形式で表示
- タグがない場合のメッセージ
- 将来の編集機能への準備

#### 2. 参照関係表示の実装
**表示内容**:
- このファイルが参照しているファイル一覧
- このファイルを参照しているファイル一覧
- 存在しないファイルの警告表示

#### 3. キャラクター情報表示の実装
**表示内容**:
- 重要度（main/sub/background）
- 複数キャラクター設定
- 表示名の自動取得結果

#### 4. レビュー情報表示の実装  
**表示内容**:
- レビュー件数の統計
- ステータス別の内訳
- 独立したアコーディオンパネル

#### 5. 基本情報表示の実装
**表示内容**:
- ファイル名、種別、サイズ
- 最終更新日時
- ハッシュ情報（デバッグ用）

### Phase 3.1d: リアルタイム更新

#### 1. ファイル変更監視
**実装方法**:
- `vscode.workspace.createFileSystemWatcher`を使用
- `.dialogoi-meta.yaml`の変更を監視
- 変更時の自動更新

#### 2. TreeView選択連携
**実装方法**:
- `treeView.onDidChangeSelection`イベント
- 選択されたアイテムの自動表示更新
- 選択解除時の処理

#### 3. メッセージング最適化
**改善点**:
- 差分更新による効率化
- 不要な更新の抑制
- エラーハンドリングの強化

### Phase 3.1e: エディタタブボタン

#### 1. エディタタイトルメニューの実装
**package.json設定**:
```json
{
  "menus": {
    "editor/title": [
      {
        "command": "dialogoi.showFileDetails",
        "group": "navigation",
        "when": "dialogoi:hasNovelProject"
      }
    ]
  }
}
```

#### 2. アクティブファイル連携
**実装内容**:
- `vscode.window.activeTextEditor`からのファイル取得
- DialogoiTreeItemへの変換処理
- WebViewの自動更新

#### 3. コンテキストメニューの追加
**追加場所**:
- TreeViewのアイテムコンテキストメニュー
- エディタのコンテキストメニュー

## 技術的考慮事項

### セキュリティ

#### Content Security Policy
```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'none'; 
               style-src ${webview.cspSource} 'unsafe-inline';
               script-src 'nonce-${nonce}';">
```

#### XSS対策
- 全ユーザー入力のHTMLエスケープ
- Nonce付きスクリプトの使用
- 外部リソース読み込みの制限

### パフォーマンス

#### 最適化ポイント
- DOM更新の最小化
- 大量データの仮想化準備
- メモリリークの防止

#### 測定項目
- WebView描画時間
- メッセージング遅延
- メモリ使用量

### エラーハンドリング

#### 例外処理
- WebView初期化失敗
- メッセージング通信エラー
- データ取得失敗

#### ユーザーフィードバック
- エラーメッセージの表示
- 適切なフォールバック処理
- ログ記録

## テスト計画

### 単体テスト
- [ ] FileDetailsViewProviderのメソッドテスト
- [ ] HTML生成機能のテスト
- [ ] メッセージング機能のテスト

### 統合テスト  
- [ ] TreeViewとの連携テスト
- [ ] リアルタイム更新のテスト
- [ ] エディタタブボタンのテスト

### ユーザビリティテスト
- [ ] 情報の見つけやすさ
- [ ] 操作の直感性
- [ ] レスポンス性能

### セキュリティテスト
- [ ] CSPの有効性確認
- [ ] XSS脆弱性テスト
- [ ] 入力値検証テスト

## 品質基準

### 機能要件
- ✅ 全メタデータ情報の正確な表示
- ✅ TreeView選択との同期
- ✅ リアルタイム更新の動作
- ✅ アコーディオンUIの正常動作

### 非機能要件
- ✅ 表示レスポンス: 500ms以内
- ✅ メモリ使用量: 10MB以下
- ✅ CSS適用: VSCodeテーマとの整合性
- ✅ セキュリティ: CSP完全準拠

### ユーザビリティ要件
- ✅ 情報アクセス: 3クリック以内
- ✅ 操作の明確さ: 説明不要の直感性
- ✅ エラー処理: 分かりやすいメッセージ

## 完了基準

### Phase 3.1a完了基準
- [ ] WebViewが正常に表示される
- [ ] TreeView選択で内容が更新される
- [ ] 基本的なメタデータが表示される
- [ ] テストが全て通過する

### Phase 3.1b完了基準
- [ ] アコーディオンパネルが正常に開閉する
- [ ] UIがVSCodeテーマに適合している
- [ ] アクセシビリティ要件を満たしている

### Phase 3.1c完了基準
- [ ] 全メタデータ情報が正確に表示される
- [ ] データがない場合の適切な表示
- [ ] エラー状態の適切な処理

### Phase 3.1d完了基準
- [ ] ファイル変更が即座に反映される
- [ ] TreeView選択と自動同期する
- [ ] パフォーマンス基準を満たしている

### Phase 3.1e完了基準
- [ ] エディタタブボタンが機能する
- [ ] アクティブファイルが正しく表示される
- [ ] コンテキストメニューが適切に動作する

## 継続的改善

### 今後の拡張予定
- タグの編集機能
- 参照関係のリンク化
- レビューの編集機能
- 統計情報の可視化

### メトリクス収集
- 機能使用頻度
- エラー発生率
- パフォーマンス指標
- ユーザーフィードバック

## リスク管理

### 技術的リスク
- **WebView API制約**: 代替手段の検討
- **パフォーマンス問題**: 最適化戦略の準備
- **セキュリティ脆弱性**: 定期的なセキュリティ監査

### 進捗リスク
- **実装複雑度**: 段階的実装による適応
- **テスト工数**: 自動化による効率化
- **ユーザビリティ**: 早期フィードバック収集