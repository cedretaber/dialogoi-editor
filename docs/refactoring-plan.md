# Dialogoi Editor 大規模リファクタリング計画書

## 概要

このドキュメントは、Dialogoi Editor VSCode拡張機能の大規模リファクタリングに関する計画、実行記録、振り返りを記録するものです。

作成日: 2025-01-28

## 目的

1. **コードベースの品質向上**
   - 技術的負債の解消
   - アーキテクチャの改善
   - 保守性・拡張性の向上

2. **開発効率の改善**
   - より明確な責務分離
   - テスタビリティの向上
   - ドキュメント整備

## リファクタリング対象候補

### 1. サービス層の責務整理
- 現状の課題
  - サービス間の依存関係が複雑
  - 責務の境界が曖昧な箇所がある
  - 循環依存の可能性

### 2. 非同期処理の統一
- 現状の課題
  - 同期・非同期メソッドが混在
  - 命名規則の不統一（Async suffix）
  - エラーハンドリングの不統一

### 3. ファイルパス処理の改善
- 現状の課題
  - 絶対パス・相対パスの扱いが統一されていない
  - パス正規化のロジックが分散
  - プラットフォーム依存の処理

### 4. エラーハンドリングの統一
- 現状の課題
  - エラーメッセージの形式が不統一
  - エラーの分類が不明確
  - ユーザーへのフィードバック方法が統一されていない

### 5. テスト構造の改善
- 現状の課題
  - モックの作成方法が統一されていない
  - テストデータの管理が分散
  - 統合テストの不足

## 実行計画

### Phase 1: 調査とアセスメント
1. 現状のコードベース分析
2. 問題点の洗い出し
3. 優先順位の決定

### Phase 2: 設計
1. 改善後のアーキテクチャ設計
2. 移行計画の策定
3. リスク評価

### Phase 3: 実装
1. 小さな単位でのリファクタリング
2. テストの追加・修正
3. ドキュメントの更新

### Phase 4: 検証
1. 機能テスト
2. パフォーマンステスト
3. 回帰テスト

## リファクタリング原則

1. **段階的な改善**
   - 一度に大きな変更を行わない
   - 各ステップでテストが通ることを確認

2. **後方互換性は考慮しない**
   - 開発段階のため、破壊的変更を恐れない
   - 最適な設計を追求

3. **テストファースト**
   - リファクタリング前にテストを充実させる
   - テストがセーフティネットとなる

4. **ドキュメント化**
   - 変更内容を記録
   - 設計決定の理由を残す

## 実行記録

### 調査結果

#### 2025-01-28: providers/, tree/, views/, webview/ ディレクトリの調査

**調査対象**: VSCode拡張機能のUI関連ディレクトリ構造

**現状の構造**:
1. **src/providers/** - WebViewプロバイダー（2ファイル）
   - `CommentsViewProvider.ts`: コメント・TODO管理のWebView
   - `FileDetailsViewProvider.ts`: ファイル詳細情報のWebView

2. **src/tree/** - TreeViewプロバイダー（1ファイル）
   - `DialogoiTreeDataProvider.ts`: ファイルツリー表示

3. **src/views/** - WebViewパネル（1ファイル）
   - `ProjectSettingsWebviewPanel.ts`: プロジェクト設定画面

4. **webview/** - React UIコンポーネント（src/外）
   - エントリーポイント3つ（index.tsx, comments.tsx, projectSettings.tsx）
   - componentsディレクトリ内にReactコンポーネント群
   - 型定義、フック、スタイル等

**責務分離の評価**: ✅ 適切
- providers/: VSCode WebView APIとの統合層（サイドバー用）
- tree/: VSCode TreeView APIの実装
- views/: メインエディタ領域のWebViewパネル管理
- webview/: React実装のUI層（VSCode APIから独立）

**発見した問題**:
1. src/webviews/ディレクトリが空（正しくはwebview/を使用）
2. 命名の紛らわしさ（webview vs views）

**良い点**:
1. VSCode API依存部分とUIロジックの明確な分離
2. TreeDataProviderがビジネスロジックをservices/に委譲
3. Reactコンポーネントの独立性（テスト可能）

### 実施内容

#### 2025-01-28: UI関連ディレクトリの整理

**実施項目**:
1. ✅ 空の`src/webviews/`ディレクトリを削除
2. ✅ `src/views/`を`src/panels/`にリネーム
   - 関連するインポートパスを更新
3. ✅ `docs/ARCHITECTURE.md`にディレクトリ構造ガイドを追加

**変更理由**:
- 紛らわしい命名（views vs webview）を解消
- より明確な責務を示す命名に統一
- 新規開発者の混乱を防ぐ

**結果**:
- providers/: サイドバーWebView
- tree/: TreeViewデータ
- panels/: メインエディタWebView
- webview/: React UI実装

### 変更点
（ここに具体的な変更点を記録）

## 振り返り

### 成果
（ここに達成した成果を記録）

### 課題
（ここに残された課題を記録）

### 学び
（ここに得られた知見を記録）

## 付録

### 参考資料
- CLAUDE.md: プロジェクトのコーディング規約
- src/di/: 依存関係注入の実装
- src/services/: サービス層の実装

### 用語集
- DI: Dependency Injection（依存関係注入）
- Repository: データアクセス層
- Service: ビジネスロジック層
- VSCode API: Visual Studio Code拡張機能API